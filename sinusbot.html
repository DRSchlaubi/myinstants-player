<title>MyInstants SinusBot Player</title>

<h1>MyInstants SinusBot Player <sup><small><small><a href="https://github.com/HarpyWar/myinstants-api">GitHub</a></small></small></sup></h1>

<div class="logout-container">
	Select Bot: <select id="bot-list"></select>
	<button id="logout">Logout</button>
</div>
<div class="clear"></div>



<div class="page-container" style="display: none">
	<div class="search-container">
		<input type="text" id="search-box" placeholder="Find in files >50000" autofocus /><button id="do-search">Search</button>
	</div>
	<div id="items">...</div>
	<div class="clear"></div>
	<div class="pagelist"></div>
	<div class="clear"></div>
</div>

<div id="login-screen">
	<img src="https://forum.sinusbot.com/sinusbot-logo.png" />

	<div id="login-form" style="display: none">
	
		<table border="0">
			<tr>
				<td>
					<label for="host">Address</label><br>
					<input type="text" id="host" value="127.0.0.1" /> 
				</td>
				<td>
					<label for="port">Port</label><br>
					<input type="text" id="port" value="8087" />
				</td>
			</tr>
			<tr>
				<td>
					<label for="admin">Login</label><br>
					<input type="text" id="login" placeholder="admin" /> 
				</td>

				<td>
					<label for="password">Password</label><br>
					<input type="password" id="password" />
				</td>
			</tr>
			<tr>
				<td colspan="2">

					<button id="auth">Login</button>
				</td>

			</tr>
		</table>


	</div>
	<div id="login-loading" class="loader"></div>
</div>

<div id="audio-container" style="display: none"></div>







<script src="https://code.jquery.com/jquery-1.4.2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
<script>
/*
 * (c) 2016 HarpyWar <harpywar@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

var itemsCount = 0; // overall items count
var currentPage = 0; // current page offset
var itemsOnPage = 180; // limit on page (const)
var searchText = ""; // limit on page (const)
var bot;

var itemTemplate,pageListTemplate; 
$(document).ready(function(){

	tryLogin();

	itemTemplate = Handlebars.compile( $('#item-template').html() );
	pageListTemplate = Handlebars.compile( $('#pagelist-template').html() );

	// event on enter 
	$('#search-box').keypress(function (event) {
		if(event.which === 13){
			// only if button is enabled
			if ( $("#do-search").attr('disabled') == false )
			{
				$("#do-search").click();
			}
		}
	});
	$("#do-search").click(function() {
		searchText = $("#search-box").val().trim();
		currentPage = 0;
		loadItems();
	});
	
	
	$("#auth").click(function(){
		login($("#host").val(), $("#port").val(), $("#login").val(), $("#password").val());
	});
	$("#logout").click(function(){
		logout();
	});
	
	loadItems();
});

function tryLogin() {
	$("#login-form").show();
	$("#login-loading").hide();
	
	if ( localStorage.getItem("host") ) {	
		$("#host").val( localStorage.getItem("host") );
		$("#port").val( localStorage.getItem("port") );
		$("#login").val( localStorage.getItem("login") );
	}
	if ( localStorage.getItem("token") ) {
		tryGetInstances( $("#host").val(), $("#port").val(), localStorage.getItem("token"));
	}
}

function login(host, port, login, password) {
	
	$("#login-form").hide();
	$("#login-loading").show();

	localStorage.setItem("host", host);
	localStorage.setItem("port", port);
	localStorage.setItem("login", login);
	
	bot = new SinusBotAPI(host, port);
	bot.auth( login, password, function(){
		localStorage.setItem("token", bot.token);

		tryGetInstances(bot.host, bot.port, bot.token);
	}, 
	function(data){
		var err = (data.error) ? data.error : "LOGIN FAILED";
		alert(err);
		logout();
	});
}
function tryGetInstances(host, port, token) {
	
	$("#login-form").hide();
	$("#login-loading").show();

	bot = new SinusBotAPI(host, port);
	bot.token = token;
	
	bot.getInstances(function(data){
		$("#bot-list").empty();
		$.each(data, function(i, item){
			$("#bot-list").append("<option value='" + item.uuid + "'>" + item.nick + "</option>");
		});
		
		$("#login-screen").hide();
		$(".page-container").fadeIn();
		$("#logout").parent().fadeIn();
	},
	function(data){
		var err = (data.error) ? data.error : "LOGIN FAILED";
		alert(err);
		logout();
	});


}


function logout() {
	$(".page-container").hide();
	$("#login-screen").fadeIn();
	$("#login-form").show();
	$("#login-loading").hide();
	$("#logout").parent().hide();
	
	if (bot) {
		bot.logout();
	}
	localStorage.removeItem("token");
}


function loadItems()
{
	$("#items").css("opacity", 0.4);
	$("#do-search").attr('disabled', true);
	
	$.get('http://api.cleanvoice.ru/myinstants/?type=many&search=' + encodeURIComponent(searchText) + '&offset=' + (currentPage*itemsOnPage) + '&limit=' + itemsOnPage, function(data){
		var json = JSON.parse(data);
		items = json.items;
		itemsCount = json.count;
		$("#items").html( itemTemplate(json) );
		
		updatePageNavigator();
		updateBinds();
		
		$("#items").css("opacity", 1.0);
		$("#do-search").attr('disabled', false);
		//$("#search-box").focus();
	});
}

function updatePageNavigator()
{
	// page navigator
	var pages = [];
	for (var i = 0; i < Math.ceil(itemsCount / itemsOnPage); i++)
	{
		var selected = (i == currentPage) ? true : false;
		pages.push({ number: i+1, selected: selected });
	}
	$(".pagelist").html(pageListTemplate(pages));
	
	$(".select-page").click(function(){
		if (currentPage-1 == $(this).text())
			return false;
	
		currentPage = $(this).text()-1;
		$(this).addClass('loading');
		loadItems();
		
		return false;
	});
}

function updateBinds()
{
	var i = 0;
	$("#items .row-container").each(function(){
		items[i].btnEl = $(this).find(".switch input:checkbox");
		items[i].durationEl = $(this).find(".row-duration span");
		
		items[i].btnEl.bind('click', play);
		i++;
	});
}
var elapsedInterval;
var items;
var currentIdx; // current or last played index

// to modify item
function getItemIndexById(id)
{
	for (var i = 0; i < items.length; i++)
	{
		if ( items[i].id == id )
		{
			return i;
		}
	}
	return false;
}

function play()
{
	var $btn = $(this); // el
	currentIdx = $btn.attr('data-idx');

	var playUrl = 'http://api.cleanvoice.ru/myinstants/?type=file&id=' + items[currentIdx].id;

	//$("#audio-container").html('<audio autoplay><source src="' + playUrl + '" type="audio/mpeg"></audio>');
	
	//
	// HINT: here may be your implementation to send audio url 
	//       to another service like SinusBot API
	//       something like the following code:
	var botId = $("#bot-list").val();
	bot.playUrl(botId, encodeURIComponent(playUrl), function(){
		playAllowed($btn);
	});
}

// activate button
function playAllowed($btn)
{
	currentIdx = $btn.attr('data-idx');
	
	var duration = Math.ceil(items[currentIdx].duration);
	var $duration = items[currentIdx].durationEl; // el
	if ($duration.text() != duration)
	$duration.text(duration); // reset duration

	//console.log(duration);
	
	// and clear old interval (may be from another checkbox)
	clearInterval(elapsedInterval);

	// update current status
	items[currentIdx].play = true;
	// check button always on click
	//$btn.attr('checked', true);
	
	
	setTimeout(function(){
		// reset all status
		for (var i = 0; i < items.length; i++)
		{
			// ignore current clicked
			if (i == currentIdx)
			{
				continue;
			}
			// if playing
			if (items[i].play == true)
			{
				//console.log(i);
				items[i].play = false;
				// uncheck button
				items[i].btnEl.attr('checked', false);
				// reset duration
				items[i].durationEl.text( Math.ceil(items[i].duration) );
			}
		};
	}, 1000);

	// decrease immediately by 1 second
	$duration.text( $duration.text() - 1 );
	
	// update elapsed time of track playing
	elapsedInterval = setInterval(function(){
		var currentDuration = parseInt( $duration.text() );
		$duration.text( --currentDuration );
		if (currentDuration < 0)
		{
			clearInterval(elapsedInterval);
			$duration.text( $duration.attr('data-init') );
			
			$btn.attr('checked', false);
		}
	}, 1000);
}


Handlebars.registerHelper('ceil', function(value) {
  return Math.ceil(value);
});

Handlebars.registerHelper('highlight', function(inputText) {
	if (searchText.length == 0)
	{
		return inputText;
	}
    var index = inputText.toLowerCase().indexOf(searchText.toLowerCase());
    if ( index >= 0 )
    { 
        inputText = inputText.substring(0,index) + "<span class='highlight'>" + inputText.substring(index,index+searchText.length) + "</span>" + inputText.substring(index + searchText.length);
    }
	return inputText;
});








function SinusBotAPI(host, port) {
	this.host = host.trim();
	this.port = port.trim();
	this.botId = false;
	this.token = false;
	this.instances = {};

	this.auth = function(login, password, callback, error) {
		var that = this;
		this.getBotId(function(){
			that.send('post', '/api/v1/bot/login', {
				'username': login.trim(),
				'password': password.trim(),
				'botid': that.botId
			}, function(data){
				that.token = data.token;
				if (callback != undefined) {
					callback(data);
				}
			}, 
			error);
		}, error);
	};
	
	this.logout = function() {
		this.token = false;
	};
	
	this.getBotId = function(callback, error) {
		var that = this;
		this.send('get', '/api/v1/botId', {}, function(data){
			that.botId = data.defaultBotId;
			if (callback != undefined) {
				callback(data);
			}
		}, error);
	};
	
	this.getInstances = function(callback, error) {
		var that = this;
		this.send('get', '/api/v1/bot/instances', {}, function(data){
			that.instances = data;
			if (callback != undefined) {
				callback(data);
			}
		}, error);
	};

	this.playUrl = function(instanceId, url, callback) {
		this.send('post', '/api/v1/bot/i/' + instanceId + '/playUrl?url=' + url, {}, function(data){
			if (callback != undefined) {
				callback(data);
			}
		});
	};
	
	this.url = function() {
		return 'http://api.cleanvoice.ru/cors/';
	};
	
	this.send = function(type, url, data, success, error) {
		var that = this;
		$.ajax( {
			url: this.url(), 
			type: type,
			data: type == 'post' ? JSON.stringify(data) : {},
			dataType: 'json',
			beforeSend: function(xhr) {
				xhr.setRequestHeader("Authorization", 'Bearer ' + that.token);
				xhr.setRequestHeader("X-Proxy-Url", 'http://' + that.host + ':' + that.port + url);
		    },
			success: function(data){
				if (data.success != 'undefined' && data.success === false) {
					if (error != undefined) {
						error(data);
					}
					return false;
				}
				if (success != undefined) {
					success(data);
				}
			},
			error: function(data){
				if (error != undefined) {
					error(data);
				}
			}
		});
	};
	
}




</script>

<script id="item-template" type="text/x-handlebars-template">
{{#each this.items}}

	<div class="row-container">
		<table><tr>
		<td>
			<div class="switch">
				<input type="checkbox" data-idx="{{@index}}">
				<label></label>
			</div> 
		</td>
		<td class="row-duration"><span data-init="{{ceil this.duration}}">{{ceil this.duration}}</span></td>
		<td class="row-title">
			<div class="row-title-container">
				<div class="row-title" title="{{this.title}}">{{{highlight this.title}}}
				</div>
			</div>
		</td>
		</tr></table>
	</div>
	
{{/each}}
</script>

<script id="pagelist-template" type="text/x-handlebars-template">
{{#if this}}
{{#each this}}
	  <a class="btn-small select-page {{#if this.selected}}disabled{{/if}}" href="" style='display: block; float: left; margin: 1px'>{{this.number}}</a>
{{/each}}
{{else}}
	Nothing found :(
{{/if}}
</script>







<style>
body {
	font-family: 'Lucida Grande', 'Helvetica Neue', sans-serif;
	font-size: 13px;
}

.page-container {
	 width: 700px
	 background: white;
}

div.row-container {
	float: left;
	margin-left: 20px;
}
div.row-title {
	position: relative;
	overflow: hidden;
	white-space: nowrap;
	background-color: #fff;
}
div.row-title:after {
	content: "";
	pointer-events: none;
	position: absolute;
	width: 20px;
	height: 100%;
	top: 0; right: 0;
	
	background-image: -webkit-linear-gradient(right, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0));
	background-image: -moz-linear-gradient(right, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0));
	background-image: -ms-linear-gradient(right, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0));
	background-image: -o-linear-gradient(right, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0));
	background-image: linear-gradient(to left, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0));
}
div.row-container table td {
	font-size: 14px;
	padding: 3px;
}


.row-title-container {
	width: 150px;
}

.row-duration {
	width: 20px;
}
.row-duration span {
	font-size: 12px;
}

/* switch button */
 *,
    *:after,
    *:before {
        box-sizing: border-box;
    }
	
.switch {
    width: 18px;
    height: 18px;
    position: relative;
}
.switch label {
    display: block;
    width: 100%;
    height: 100%;
    position: relative;
    border-radius: 50%;
    background: #eaeaea;
    box-shadow: 
        0 3px 5px rgba(0,0,0,0.25),
        inset 0 1px 0 rgba(255,255,255,0.3),
        inset 0 -5px 5px rgba(100,100,100,0.1),
        inset 0 5px 5px rgba(255,255,255,0.3);
}
.switch label:after {
    content: "";
    position: absolute;
    z-index: -1;
    top: -8%; 
    right: -8%; 
    bottom: -8%; 
    left: -8%;
    border-radius: inherit;
    background: #ddd; /* Fallback */
    background: linear-gradient(#ccc, #fff);
    box-shadow: 
        inset 0 2px 1px rgba(0,0,0,0.15),
        0 2px 5px rgba(200,200,200,0.1);
}
.switch label:before {
    content: "";
    position: absolute;
    width: 20%;
    height: 20%; 
    left: 40%;
    top: 40%;
    border-radius: inherit;
    background: #969696; /* Fallback */
    background: radial-gradient(40% 35%, #ccc, #969696 60%);
    box-shadow:
        inset 0 2px 4px 1px rgba(0,0,0,0.3),
        0 1px 0 rgba(255,255,255,1),
        inset 0 1px 0 white;
}
.switch input {
    /* First, we make it as wide as the container */
    position: absolute;
    width: 100%;
    height: 100%;
    /* Then, we put it on top of everything else */
    z-index: 100;
    /* Last, we make it invisible */
    opacity: 0;
    /* This one is just for ergonomy */
    cursor: pointer;
	margin: 0;
}
.switch input:checked ~ label { /* Button */
	background: #e5e5e5; /* Fallback */
    background: linear-gradient(#dedede, #fdfdfd);
}

.switch input:checked ~ label:before { /* LED */
    background: #25d025; /* Fallback */
    background: radial-gradient(40% 35%, #5aef5a, #25d025 60%);
    box-shadow:
        inset 0 3px 5px 1px rgba(0,0,0,0.1),
        0 1px 0 rgba(255,255,255,0.4),
        0 0 10px 2px rgba(0, 210, 0, 0.5);
}

.clear {
	clear: both;
}

/* page navigator */
.pagelist {
	margin-top: 24px;
	width: 100%;
	padding-bottom: -24px;
}



.btn-small {
  background: #3498db;
  background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
  background-image: -moz-linear-gradient(top, #3498db, #2980b9);
  background-image: -ms-linear-gradient(top, #3498db, #2980b9);
  background-image: -o-linear-gradient(top, #3498db, #2980b9);
  background-image: linear-gradient(to bottom, #3498db, #2980b9);
  font-family: Arial;
  color: #ffffff;
  font-size: 13px;
  padding: 5px 10px 5px 10px;
  text-decoration: none;
}

.btn-small:hover {
  background: #3cb0fd;
  background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
  background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
  background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
  background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
  background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
  text-decoration: none;
}

.btn-small.disabled {
  background: silver;.
}
.btn-small.loading {
  background: crimson;.
}

.search-container {
	margin: 25px;
	margin-bottom: 10px;
}
#search-box, #do-search {
	padding: 5px 3px;display:table-cell;
}
#search-box {
	width: 90%;
}
#do-search {
	width: 10%;
}

.highlight
{
	background-color: #F9F0B5;
}





/* login */
#login-screen {
	text-align: center;
	background: #0DC5C1;
	padding-top: 40px;
	height: 370px;
}
#login-form {
	margin: auto;
	width: 500px;
	padding: 10px 50px 30px;
}
#login-form table{
	margin-top: 20px;
	width: 100%;
}

#login-form table td{
	padding: 10px;
	width: 50%;
}
#login-form label {
	font-weight: bold;
	color: white;
	font-size: 13px;
}

#login-form input {
	padding: 7px;
	margin-top: 2px;
	width: 100%;
}
#login-form button {
	padding: 15px;
	width: 100%;
	font-size: 18px;
}

.logout-container {
	display: none;
	position: absolute; 
	width: 98%; 
	margin-top: -50px; 
	text-align: right
}


#login-loading {
	margin-top: 110px;
}


/* ajax loader */
.loader,
.loader:before,
.loader:after {
  border-radius: 50%;
}
.loader:before,
.loader:after {
  position: absolute;
  content: '';
}
.loader:before {
  width: 5.2em;
  height: 10.2em;
  background: #0dc5c1;
  border-radius: 10.2em 0 0 10.2em;
  top: -0.1em;
  left: -0.1em;
  -webkit-transform-origin: 5.2em 5.1em;
  transform-origin: 5.2em 5.1em;
  -webkit-animation: load2 2s infinite ease 1.5s;
  animation: load2 2s infinite ease 1.5s;
}
.loader {
  font-size: 11px;
  text-indent: -99999em;
  margin: 55px auto;
  position: relative;
  width: 10em;
  height: 10em;
  box-shadow: inset 0 0 0 1em #ffffff;
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
}
.loader:after {
  width: 5.2em;
  height: 10.2em;
  background: #0dc5c1;
  border-radius: 0 10.2em 10.2em 0;
  top: -0.1em;
  left: 5.1em;
  -webkit-transform-origin: 0px 5.1em;
  transform-origin: 0px 5.1em;
  -webkit-animation: load2 2s infinite ease;
  animation: load2 2s infinite ease;
}
@-webkit-keyframes load2 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@keyframes load2 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}


</style>

<br>
<div style="width: 100%; text-align: right;">(c) 2016, <a rel="license" href="http://harpywar.com">HarpyWar</a>.</div>
